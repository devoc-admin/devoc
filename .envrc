# Chargé par direnv pour préparer l'environnement de dev du monorepo

# Utilitaires stdlib direnv
{ declare -F dotenv >/dev/null 2>&1; } || source "$DIRENV_LIBDIR/stdlib.sh"


# Verifications de base
if ! has git; then
  log_error "git introuvable. Installez-le: 'brew install git' (Homebrew/Linuxbrew)"
  exit 1
fi

PATH_add "$HOME/.bun/bin"
if ! has bun; then
  log_error "Bun introuvable. Installez-le: 'brew install oven-sh/bun/bun' (Homebrew/Linuxbrew)"
  exit 1
fi

if ! has just; then
  log_status "[Optionnel] Just n'est pas installé, vous pouvez l'installer comme suit: brew install just"
fi

# PATH locaux (binaires du projet)
layout node

if ! has node; then
  log_error "Node.js introuvable. Installez-le: 'brew install node' (ou utilisez asdf/fnm/nvm). Activez Corepack ensuite: 'corepack enable'"
  exit 1
fi

log_status "node: $(node --version 2>/dev/null)"
log_status "bun: $(bun --version 2>/dev/null)"
if has turbo; then
  log_status "turbo available (local via PATH)"
else
  log_status "turbo will be used via 'bun x turbo'"
fi

# Aliases pratiques (utilise les binaires locaux si dispos)
alias turbo="bun x turbo"
alias biome="bun x biome"

# Télémétrie (optionnel)
export NEXT_TELEMETRY_DISABLED=${NEXT_TELEMETRY_DISABLED:-1}
export TURBO_TELEMETRY_DISABLED=${TURBO_TELEMETRY_DISABLED:-1}

# Variables d'environnement du monorepo
#    Chargement depuis fichiers .env si présents
dotenv_if_exists .env
dotenv_if_exists .env.local

#    Placeholders sûrs si non définis (modifiez-les au besoin)
export NODE_ENV=${NODE_ENV:-development}
export CONTACT_EMAIL=${CONTACT_EMAIL:-contact@example.com}

#    Ces variables sont référencées par turbo.json. Laissez vides si non utilisées.
: "${RESEND_API_KEY:=}"
: "${DATABASE_URL:=}"
: "${PAYLOAD_SECRET:=}"
: "${BLOB_READ_WRITE_TOKEN:=}"
: "${POSTGRES_URL:=}"
export RESEND_API_KEY DATABASE_URL PAYLOAD_SECRET BLOB_READ_WRITE_TOKEN POSTGRES_URL

# Installation auto
log_status "Installation des dépendances si necessaire (bun install)..."
bun install >/dev/null 2>&1 || log_error "Échec bun install (vous pouvez l'exécuter manuellement)."
log_status "Installation des hooks Git lefthook..."
lefthook install >/dev/null 2>&1 || true

log_status "Environnement de développement prêt."

# Fichiers à surveiller pour recharger l'env
watch_file package.json turbo.json lefthook.yml .env .env.local
