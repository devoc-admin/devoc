# Chargé par direnv pour préparer l'environnement de dev du monorepo

# Utilitaires stdlib direnv
{ declare -F dotenv >/dev/null 2>&1; } || source "$DIRENV_LIBDIR/stdlib.sh"


# Verifications de base
if ! has git; then
  log_error "git introuvable. Installez-le: 'brew install git' (Homebrew/Linuxbrew)"
  exit 1
fi

PATH_add "$HOME/.bun/bin"
if ! has bun; then
  log_error "Bun introuvable. Installez-le: 'brew install oven-sh/bun/bun' (Homebrew/Linuxbrew)"
  exit 1
fi

if ! has just; then
  log_status "[Optionnel] Just n'est pas installé, vous pouvez l'installer comme suit: brew install just"
fi

# PATH locaux (binaires du projet)
layout node

if ! has node; then
  log_error "Node.js introuvable. Installez-le: 'brew install node' (ou utilisez asdf/fnm/nvm). Activez Corepack ensuite: 'corepack enable'"
  exit 1
fi

if has corepack; then
  corepack enable >/dev/null 2>&1 || true
  corepack prepare "pnpm@10.20.0" --activate >/dev/null 2>&1 || true
fi

if ! has pnpm; then
  log_error "pnpm introuvable. Avec Node récent: 'corepack enable' puis 'corepack prepare pnpm@10.20.0 --activate'. Alternatif: 'brew install pnpm' ou 'npm i -g pnpm@10.20.0'"
  exit 1
fi

log_status "node: $(node --version 2>/dev/null)"
log_status "pnpm: $(pnpm --version 2>/dev/null) (via corepack si applicable)"
if has turbo; then
  log_status "turbo disponible (local via PATH)"
else
  log_status "turbo sera utilisé via 'pnpm turbo' (alias fourni)"
fi
log_status "bun: $(bun --version 2>/dev/null)"

# Aliases pratiques (utilise les binaires locaux si dispos)
if has pnpm; then
  alias turbo="pnpm turbo"
  alias biome="pnpm biome"
fi

# Télémétrie (optionnel)
export NEXT_TELEMETRY_DISABLED=${NEXT_TELEMETRY_DISABLED:-1}
export TURBO_TELEMETRY_DISABLED=${TURBO_TELEMETRY_DISABLED:-1}

# Variables d'environnement du monorepo
#    Chargement depuis fichiers .env si présents
dotenv_if_exists .env
dotenv_if_exists .env.local

#    Placeholders sûrs si non définis (modifiez-les au besoin)
export NODE_ENV=${NODE_ENV:-development}
export CONTACT_EMAIL=${CONTACT_EMAIL:-contact@example.com}

#    Ces variables sont référencées par turbo.json. Laissez vides si non utilisées.
: "${RESEND_API_KEY:=}"
: "${DATABASE_URL:=}"
: "${PAYLOAD_SECRET:=}"
: "${BLOB_READ_WRITE_TOKEN:=}"
: "${POSTGRES_URL:=}"
export RESEND_API_KEY DATABASE_URL PAYLOAD_SECRET BLOB_READ_WRITE_TOKEN POSTGRES_URL

# Installation auto
log_status "Installation des dépendances si necessaire (pnpm install --recursive)..."
pnpm install --recursive >/dev/null 2>&1 || log_error "Échec pnpm install --recursive (vous pouvez l'exécuter manuellement)."
log_status "Installation des hooks Git lefthook..."
lefthook install >/dev/null 2>&1 || true

log_status "Environnement de développement prêt."

# Fichiers à surveiller pour recharger l'env
watch_file package.json pnpm-workspace.yaml turbo.json lefthook.yml .env .env.local
